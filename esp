local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local espList = {}

local function getRainbowColor(t)
	return Color3.fromHSV((t % 5) / 5, 1, 1)
end

local function createESP(player)
	if player == LocalPlayer then return end
	local char = player.Character
	if not char then return end
	local head = char:FindFirstChild("Head")
	if not head then return end

	local gui = Instance.new("BillboardGui")
	gui.AlwaysOnTop = true
	gui.Size = UDim2.new(0, 120, 0, 40)
	gui.StudsOffset = Vector3.new(0, 2.5, 0)
	gui.Adornee = head

	local displayLabel = Instance.new("TextLabel")
	displayLabel.Name = "Display"
	displayLabel.BackgroundTransparency = 1
	displayLabel.Size = UDim2.new(1, 0, 0.5, 0)
	displayLabel.Position = UDim2.new(0, 0, 0, 0)
	displayLabel.Text = player.DisplayName
	displayLabel.TextScaled = true
	displayLabel.Font = Enum.Font.GothamBold
	displayLabel.TextStrokeTransparency = 0.2
	displayLabel.TextColor3 = Color3.new(1, 1, 1)
	displayLabel.Parent = gui

	local userLabel = Instance.new("TextLabel")
	userLabel.Name = "Username"
	userLabel.BackgroundTransparency = 1
	userLabel.Size = UDim2.new(1, 0, 0.5, 0)
	userLabel.Position = UDim2.new(0, 0, 0.5, 0)
	userLabel.Text = "@" .. player.Name
	userLabel.TextScaled = true
	userLabel.Font = Enum.Font.Gotham
	userLabel.TextStrokeTransparency = 0.4
	userLabel.TextColor3 = Color3.new(1, 1, 1)
	userLabel.Parent = gui

	gui.Parent = head

	espList[player] = {
		gui = gui,
		display = displayLabel,
		username = userLabel,
		char = char
	}
end

local function removeESP(player)
	local esp = espList[player]
	if esp and esp.gui then
		esp.gui:Destroy()
	end
	espList[player] = nil
end

RunService.RenderStepped:Connect(function()
	local t = tick()
	for player, esp in pairs(espList) do
		if player and esp.char and esp.char.Parent then
			local color = getRainbowColor(t)
			esp.display.TextColor3 = color
			esp.username.TextColor3 = color
		else
			removeESP(player)
		end
	end
end)

for _, player in ipairs(Players:GetPlayers()) do
	createESP(player)
	player.CharacterAdded:Connect(function()
		wait(1)
		createESP(player)
	end)
end

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function()
		wait(1)
		createESP(player)
	end)
end)

Players.PlayerRemoving:Connect(removeESP)
