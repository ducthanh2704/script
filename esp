local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local espList = {}

local function getRainbowColor(t)
	local h = t % 5 / 5
	return Color3.fromHSV(h, 1, 1)
end

local function getBoundingBox(model)
	local parts = {}
	for _, part in ipairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			table.insert(parts, part)
		end
	end
	if #parts == 0 then return nil end
	local cf, size = nil, nil
	cf, size = model:GetBoundingBox()
	return cf, size
end

local function createESP(player)
	if player == LocalPlayer or espList[player] then return end
	local character = player.Character
	if not character then return end
	local head = character:FindFirstChild("Head")
	if not head then return end

	local nameGui = Instance.new("BillboardGui")
	nameGui.AlwaysOnTop = true
	nameGui.Size = UDim2.new(0, 100, 0, 20)
	nameGui.StudsOffset = Vector3.new(0, 2.5, 0)
	nameGui.Adornee = head

	local nameLabel = Instance.new("TextLabel")
	nameLabel.BackgroundTransparency = 1
	nameLabel.Size = UDim2.new(1, 0, 1, 0)
	nameLabel.Text = player.Name
	nameLabel.TextScaled = true
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextStrokeTransparency = 0.2
	nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	nameLabel.Parent = nameGui
	nameGui.Parent = head

	local cf, size = getBoundingBox(character)
	if not cf then return end

	local box = Instance.new("BoxHandleAdornment")
	box.Adornee = nil
	box.AlwaysOnTop = true
	box.ZIndex = 0
	box.Size = size
	box.Color3 = Color3.fromRGB(255, 255, 255)
	box.Transparency = 0.5
	box.Parent = workspace

	espList[player] = {
		name = nameLabel,
		gui = nameGui,
		box = box,
		char = character
	}
end

local function removeESP(player)
	local esp = espList[player]
	if esp then
		if esp.gui then esp.gui:Destroy() end
		if esp.box then esp.box:Destroy() end
		espList[player] = nil
	end
end

RunService.RenderStepped:Connect(function()
	local t = tick()
	for player, esp in pairs(espList) do
		if player and esp.char and esp.char.Parent then
			esp.name.TextColor3 = getRainbowColor(t)
			local cf, size = getBoundingBox(esp.char)
			if cf and size then
				esp.box.CFrame = cf
				esp.box.Size = size
				esp.box.Adornee = nil
			end
		else
			removeESP(player)
		end
	end
end)

for _, player in pairs(Players:GetPlayers()) do
	createESP(player)
end

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function()
		wait(1)
		createESP(player)
	end)
end)

Players.PlayerRemoving:Connect(removeESP)
