local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local espList = {}
local espEnabled = true

local function getRainbowColor(t)
	return Color3.fromHSV((t % 5) / 5, 1, 1)
end

local function findAdornee(char)
	local part = nil
	local maxY = -math.huge
	for _, p in pairs(char:GetChildren()) do
		if p:IsA("BasePart") and p.Position.Y > maxY then
			part = p
			maxY = p.Position.Y
		end
	end
	return part
end

local function createESP(player)
	if not espEnabled then return end
	if not player.Character then return end

	local part = findAdornee(player.Character)
	local gui = espList[player] and espList[player].gui

	if not gui then
		gui = Instance.new("BillboardGui")
		gui.AlwaysOnTop = true
		gui.Size = UDim2.new(0, 120, 0, 40)
		gui.StudsOffset = Vector3.new(0, 2.5, 0)

		local name = Instance.new("TextLabel")
		name.BackgroundTransparency = 1
		name.Size = UDim2.new(1, 0, 0.5, 0)
		name.Position = UDim2.new(0, 0, 0, 0)
		name.Text = player.DisplayName
		name.TextScaled = true
		name.Font = Enum.Font.GothamBold
		name.TextStrokeTransparency = 0.2
		name.TextColor3 = Color3.new(1, 1, 1)
		name.Parent = gui

		local user = Instance.new("TextLabel")
		user.BackgroundTransparency = 1
		user.Size = UDim2.new(1, 0, 0.5, 0)
		user.Position = UDim2.new(0, 0, 0.5, 0)
		user.Text = "@" .. player.Name
		user.TextScaled = true
		user.Font = Enum.Font.Gotham
		user.TextStrokeTransparency = 0.4
		user.TextColor3 = Color3.new(1, 1, 1)
		user.Parent = gui

		espList[player] = {gui = gui, name = name, user = user}
	end

	if part then
		gui.Adornee = part
		gui.Parent = part
	end
end

local function setupPlayer(player)
	player.CharacterAdded:Connect(function()
		task.spawn(function()
			while player.Character do
				createESP(player)
				task.wait(0.3)
			end
		end)
	end)

	if player.Character then
		task.spawn(function()
			while player.Character do
				createESP(player)
				task.wait(0.3)
			end
		end)
	end
end

Players.PlayerAdded:Connect(setupPlayer)
Players.PlayerRemoving:Connect(function(player)
	if espList[player] and espList[player].gui then
		espList[player].gui:Destroy()
	end
	espList[player] = nil
end)

for _, p in pairs(Players:GetPlayers()) do
	if p ~= LocalPlayer then
		setupPlayer(p)
	end
end

RunService.RenderStepped:Connect(function()
	local t = tick()
	for player, data in pairs(espList) do
		if data.name then data.name.TextColor3 = getRainbowColor(t) end
		if data.user then data.user.TextColor3 = getRainbowColor(t) end
		if data.gui and data.gui.Parent and not espEnabled then
			data.gui.Enabled = false
		elseif data.gui then
			data.gui.Enabled = true
		end
	end
end)

UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.L then
		espEnabled = not espEnabled
	end
end)
